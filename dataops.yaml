apiVersion: pipe.seg.dev/v1
pipeline_steps:
  - name: validate
    trigger_events:
      - pull_request
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    environment:
      PRD_TESTE: "PRD"
      LOCAL_TESTE: "REPO"
    commands:
      # --- COMANDOS DE DEPURACAO (NOVOS OU ALTERADOS) ---
      - echo "--- Conteúdo do Working Directory atual (.):"
      - ls -la .
      - echo "--- df -h (uso do disco e montagens):"
      - df -h
      - echo "--- mount (todos os pontos de montagem):"
      - mount
      - echo "--- Conteúdo da raiz do workspace /workspace/source-code:"
      - ls -la /workspace/source-code
      - echo "--- Conteúdo do subdiretório clonado /workspace/source-code/$(params.repo-name):"
      - ls -la /workspace/source-code/$(params.repo-name)
      - echo "--- Diretório de trabalho atual (pwd):"
      - pwd
      # --- FIM DOS COMANDOS DE DEPURACAO ---
      - python3 -m pip install -r ./requirements/requirements_install.txt
      - make print-teste
      - echo $PRD_TESTE
      - echo $CHANGED_FILES_LIST

  - name: build
    trigger_events:
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    commands:
      - echo "Rodando build"
      - make print-teste

  - name: deploy
    trigger_events:
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    runAfter:
      - build
    commands:
      - echo "Deploy para prod"
      - make print-teste

  - name: teste
    trigger_events:
      - pull_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    environment:
      PRD_TESTE: "PRD"
      LOCAL_TESTE: "REPO"
    runAfter:
      - validate
    commands:
      # --- COMANDOS DE DEPURACAO (NOVOS OU ALTERADOS) ---
      - echo "--- Conteúdo do Working Directory atual (.):"
      - ls -la .
      - echo "--- df -h (uso do disco e montagens):"
      - df -h
      - echo "--- mount (todos os pontos de montagem):"
      - mount
      - echo "--- Conteúdo da raiz do workspace /workspace/source-code:"
      - ls -la /workspace/source-code
      - echo "--- Conteúdo do subdiretório clonado /workspace/source-code/$(params.repo-name):"
      - ls -la /workspace/source-code/$(params.repo-name)
      - echo "--- Diretório de trabalho atual (pwd):"
      - pwd
      # --- FIM DOS COMANDOS DE DEPURACAO ---
      - echo LOCAL_TESTE
      - echo PRD_TESTE
      - make print-teste
