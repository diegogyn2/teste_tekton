apiVersion: pipe.seg.dev/v1
pipeline_steps:
  - name: validate
    trigger_events:
      - pull_request
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    environment:
      PRD_TESTE: "PRD"
      LOCAL_TESTE: "REPO"
    commands:
      - echo "--- Início da Depuração da Task 'validate' ---"
      - echo "ID do Usuário: $(id -u)" # Qual usuário está executando?
      - echo "Grupo do Usuário: $(id -g)" # Qual grupo está executando?
      - echo "Diretório de Trabalho Atual (pwd):"
      - pwd
      - echo "Conteúdo do Diretório de Trabalho Atual (ls -la .):"
      - ls -la . # Lista o conteúdo do diretório atual
      - echo "Conteúdo do Diretório 'requirements':"
      - ls -la ./requirements/ # Verifica se 'requirements' existe e o que tem dentro
      - echo "Caminho completo do make: $(which make)" # Onde o make está localizado
      - echo "--- Fim da Depuração da Task 'validate' ---"
      - python3 -m pip install -r ./requirements/requirements_install.txt # <- Linha que falha
      - make print-teste # <- Linha que falha
      - echo $PRD_TESTE
      - echo $CHANGED_FILES_LIST

  - name: build
    trigger_events:
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    commands:
      - echo "Rodando build"
      - make print-teste

  - name: deploy
    trigger_events:
      - merge_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    runAfter:
      - build
    commands:
      - echo "Deploy para prod"
      - make print-teste

  - name: teste
    trigger_events:
      - pull_request
    branches:
      - qa
      - main
    image: python:3.11.7-bookworm
    environment:
      PRD_TESTE: "PRD"
      LOCAL_TESTE: "REPO"
    runAfter:
      - validate
    commands:
      - echo LOCAL_TESTE
      - echo PRD_TESTE
      - make print-teste
